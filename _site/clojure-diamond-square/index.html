<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <link rel="icon" href="/favicon.ico" sizes="32x32" type="image/x-icon">

    <!--  Apple  -->
    <link rel="apple-touch-icon-precomposed" href="/imgs/favicon/apple-touch-icon-precomposed.png">

    <!--  Microsoft  -->
    <meta name="msapplication-TileColor" content="#D8F0CC">
    <meta name="msapplication-TileImage" content="/imgs/favicon/tileicon.png">

    <!-- General page specifics -->

    <!-- title variable -->
    

        

    

    <!-- url variable -->
    

        

    

    <!-- author variable -->
    

        

    

    <!-- keywords variable -->
    

    <title>Random Terrain Generation, A Clojure Walkthrough | Cryptic Chat</title>
    <meta name="description" content="We are a group of developers involved in the tech industry that work, laugh, discover, and grow together. We encourage each other to push the boundaries of the technology we work with everyday. To help reach our personal goals we collaborating often and want others to share in this  experience.
">
    <meta name="keywords" content="                                    clojure,                            terrain,                        ">
    <meta name="author" content="Chris Dolphin">

    <!-- Facebook page specifics -->
    <meta property="og:title" content="Random Terrain Generation, A Clojure Walkthrough | Cryptic Chat">
    <meta property="og:description" content="We are a group of developers involved in the tech industry that work, laugh, discover, and grow together. We encourage each other to push the boundaries of the technology we work with everyday. To help reach our personal goals we collaborating often and want others to share in this  experience.
">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Cryptic Chat">
    <meta property="og:image" content="">

    <!-- Twitter page specifics -->
    <meta name="twitter:title" content="Random Terrain Generation, A Clojure Walkthrough | Cryptic Chat">
    <meta name="twitter:description" content="We are a group of developers involved in the tech industry that work, laugh, discover, and grow together. We encourage each other to push the boundaries of the technology we work with everyday. To help reach our personal goals we collaborating often and want others to share in this  experience.
">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:url" content="/clojure-diamond-square/">
    <meta name="twitter:site" content="@likethemammal">
    <meta name="twitter:image" content="">


    <link rel="stylesheet" href="/styles.css">
    <link rel="canonical" href="https://cryptic.io/clojure-diamond-square/">

    <link href="//fonts.googleapis.com/css?family=Open+Sans:400italic,400,600" rel="stylesheet" type="text/css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-37560411-4', 'auto');
    ga('require', 'displayfeatures');
    ga('send', 'pageview');

</script>

</head>


  

  <body>

  

    <div id="nav-band">
    <div id="nav">
        <a id="logo" href="/">
            <i class="fa fa-users"></i>
            Cryptic: chat
        </a>

        <nav id="desktop-nav">
            <a class="nav-item" href="/search" title="Search">Search</a>
            <a class="nav-item" href="/tags" title="Tags">Tags</a>
            <a class="nav-item" href="/members" title="Members">Members</a>
            <a class="nav-item" href="http://github.com/cryptic-io/cryptic-chat/" title="Github Repo">Github</a>
            <a class="nav-item" href="/about" title="About">About</a>
            <a class="nav-item" href="/" title="Blog">Blog</a>
        </nav>

        <input id="mobile-nav-open" class="mobile-nav-toggle" type="text" readonly>
        <input id="mobile-nav-close" class="mobile-nav-toggle" type="text" readonly>

        <nav id="mobile-nav">
            <a class="nav-item" href="/" title="Blog">Blog</a>
            <a class="nav-item" href="/about" title="About">About</a>
            <a class="nav-item" href="http://github.com/cryptic-io/cryptic-chat/" title="Github Repo">Github</a>
            <a class="nav-item" href="/members" title="Members">Members</a>
            <a class="nav-item" href="/tags" title="Tags">Tags</a>
            <a class="nav-item" href="/search" title="Search">Search</a>
        </nav>

    </div>
</div>


    <div id="main">

        







    <div id="post">

        <header id="post-header" class="cf">

            <a href="#author" title="Author">
                <div id="post-author-avatar">
                    <img id="post-author-img-bg" src="https://avatars.githubusercontent.com/u/933154" alt="Brian Picciano background" title="Brian Picciano background"/>
                    <img id="post-author-img" src="https://avatars.githubusercontent.com/u/933154" alt="Brian Picciano Avatar Image" title="Brian Picciano"/>
                </div>
            </a>

            <div id="post-header-words">

                <h1 id="post-title">

                    <span id="post-title-text">
                        Random Terrain Generation, A Clojure Walkthrough
                    </span>

                    <div id="post-tags">
                        
                            <a class="post-tag" href="/tags#clojure" title="clojure">#clojure</a>
                        
                            <a class="post-tag" href="/tags#terrain" title="terrain">#terrain</a>
                        
                    </div>
                </h1>

                <div id="post-metadata">
                    <span id="post-date">Oct 28, 2014</span>
                    •
                    <a id="disqus-num-comments" href="#disqus_thread" title="To the comments">0 comments</a>
                </div>

            </div>

        </header>

        <div id="post-assets">

            

            
            <div class="post-asset-container">
                <a id="post-source" class="post-asset" href="https://github.com/mediocregopher/diamond-square" title="Source">Source</a>
            </div>
            

        </div>

        
          <div class="post-crosspost-container">
            This was cross-posted on <a href="http://blog.mediocregopher.com/clojure-diamond-square.html">http://blog.mediocregopher.com/clojure-diamond-square.html</a>
          </div>
        

        <article id="post-content">

            <p><img src="/imgs/article/dsqr-terrain.png" alt="terrain"></p>

<p>I recently started looking into the diamond-square algorithm (you
can find a great article on it <a href="http://www.gameprogrammer.com/fractal.html">here</a>). The following
is a short-ish walkthrough of how I tackled the problem in clojure
and the results. You can find the <a href="https://github.com/technomancy/leiningen">leiningen</a> repo
<a href="https://github.com/mediocregopher/diamond-square">here</a> and follow along within that, or simply read the code
below to get an idea.</p>

<p>Also, @Marco ported my code into clojurescript, so you can get random
terrain in your browser. <a href="http://marcopolo.io/diamond-square/">Check it out!</a></p>
<div class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span class="p">(</span><span class="kd">ns </span><span class="nv">diamond-square.core</span><span class="p">)</span>

<span class="c1">; == The Goal ==</span>
<span class="c1">; Create a fractal terrain generator using clojure</span>

<span class="c1">; == The Algorithm ==</span>
<span class="c1">; Diamond-Square. We start with a grid of points, each with a height</span>
<span class="c1">; of 0.</span>
<span class="c1">;</span>
<span class="c1">; 1. Take each corner point of the square, average the heights, and</span>
<span class="c1">;    assign that to be the height of the midpoint of the square.</span>
<span class="c1">;    Increase/decrease this midpoint by some random amount (an error factor).</span>
<span class="c1">;</span>
<span class="c1">; 2. Creating a line from the midpoint to each corner we get four</span>
<span class="c1">;    half-diamonds.  Average the heights of the points (with some</span>
<span class="c1">;    random error) and assign the heights to the midpoints of the</span>
<span class="c1">;    diamonds.</span>
<span class="c1">;</span>
<span class="c1">; 3. We now have four square sections, start at 1 for each of them</span>
<span class="c1">;    (with decreasing amount of error for each iteration).</span>
<span class="c1">;</span>
<span class="c1">; This picture explains it better than I can:</span>
<span class="c1">; https://raw2.github.com/mediocregopher/diamond-square/master/resources/dsalg.png</span>
<span class="c1">; (http://nbickford.wordpress.com/2012/12/21/creating-fake-landscapes/dsalg/)</span>
<span class="c1">;</span>
<span class="c1">; == The Strategy ==</span>
<span class="c1">; We begin with a vector of vectors of numbers, and iterate over it,</span>
<span class="c1">; filling in spots as they become available. Our grid will have the</span>
<span class="c1">; top-left being (0,0), y being pointing down and x going to the</span>
<span class="c1">; right. The outermost vector indicating row number (y) and the</span>
<span class="c1">; inner vectors indicate the column number (x)</span>
<span class="c1">;</span>
<span class="c1">; = Utility =</span>
<span class="c1">; First we create some utility functions for dealing with vectors of</span>
<span class="c1">; vectors.</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">print-m</span>
  <span class="s">&quot;Prints a grid in a nice way&quot;</span>
  <span class="p">[</span><span class="nv">m</span><span class="p">]</span>
  <span class="p">(</span><span class="nb">doseq </span><span class="p">[</span><span class="nv">n</span> <span class="nv">m</span><span class="p">]</span>
    <span class="p">(</span><span class="nb">println </span><span class="nv">n</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">get-m</span>
  <span class="s">&quot;Gets a value at the given x,y coordinate of the grid, with [0,0]</span>
<span class="s">  being in the top left&quot;</span>
  <span class="p">[</span><span class="nv">m</span> <span class="nv">x</span> <span class="nv">y</span><span class="p">]</span>
  <span class="p">((</span><span class="nf">m</span> <span class="nv">y</span><span class="p">)</span> <span class="nv">x</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">set-m</span>
  <span class="s">&quot;Sets a value at the given x,y coordinat of the grid, with [0,0]</span>
<span class="s">  being in the top left&quot;</span>
  <span class="p">[</span><span class="nv">m</span> <span class="nv">x</span> <span class="nv">y</span> <span class="nv">v</span><span class="p">]</span>
  <span class="p">(</span><span class="nb">assoc </span><span class="nv">m</span> <span class="nv">y</span>
    <span class="p">(</span><span class="nb">assoc </span><span class="p">(</span><span class="nf">m</span> <span class="nv">y</span><span class="p">)</span> <span class="nv">x</span> <span class="nv">v</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">add-m</span>
  <span class="s">&quot;Like set-m, but adds the given value to the current on instead of</span>
<span class="s">  overwriting it&quot;</span>
  <span class="p">[</span><span class="nv">m</span> <span class="nv">x</span> <span class="nv">y</span> <span class="nv">v</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">set-m</span> <span class="nv">m</span> <span class="nv">x</span> <span class="nv">y</span>
   <span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nf">get-m</span> <span class="nv">m</span> <span class="nv">x</span> <span class="nv">y</span><span class="p">)</span> <span class="nv">v</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">avg</span>
  <span class="s">&quot;Returns the truncated average of all the given arguments&quot;</span>
  <span class="p">[</span><span class="o">&amp;</span> <span class="nv">l</span><span class="p">]</span>
  <span class="p">(</span><span class="nb">int </span><span class="p">(</span><span class="nb">/ </span><span class="p">(</span><span class="nb">reduce + </span><span class="nv">l</span><span class="p">)</span> <span class="p">(</span><span class="nb">count </span><span class="nv">l</span><span class="p">))))</span>

<span class="nb">= </span><span class="nv">Grid</span> <span class="nv">size</span> <span class="nv">=</span>
<span class="c1">; Since we&#39;re starting with a blank grid we need to find out what</span>
<span class="c1">; sizes the grids can be. For convenience the size (height and</span>
<span class="c1">; width) should be odd, so we easily get a midpoint. And on each</span>
<span class="c1">; iteration we&#39;ll be halfing the grid, so whenever we do that the</span>
<span class="c1">; two resultrant grids should be odd and halfable as well, and so</span>
<span class="c1">; on.</span>
<span class="c1">;</span>
<span class="c1">; The algorithm that fits this is size = 2^n + 1, where 1 &lt;= n. For</span>
<span class="c1">; the rest of this guide I&#39;ll be referring to n as the &quot;degree&quot; of</span>
<span class="c1">; the grid.</span>


<span class="p">(</span><span class="k">def </span><span class="nv">exp2-pre-compute</span>
  <span class="p">(</span><span class="nf">vec</span> <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nb">int </span><span class="p">(</span><span class="nf">Math/pow</span> <span class="mi">2</span> <span class="nv">%</span><span class="p">))</span> <span class="p">(</span><span class="nb">range </span><span class="mi">31</span><span class="p">))))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">exp2</span>
  <span class="s">&quot;Returns 2^n as an integer. Uses pre-computed values since we end</span>
<span class="s">  up doing this so much&quot;</span>
  <span class="p">[</span><span class="nv">n</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">exp2-pre-compute</span> <span class="nv">n</span><span class="p">))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">grid-sizes</span>
  <span class="p">(</span><span class="nf">vec</span> <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nb">inc </span><span class="p">(</span><span class="nf">exp2</span> <span class="nv">%</span><span class="p">))</span> <span class="p">(</span><span class="nb">range </span><span class="mi">1</span> <span class="mi">31</span><span class="p">))))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">grid-size</span> <span class="p">[</span><span class="nv">degree</span><span class="p">]</span>
  <span class="p">(</span><span class="nb">inc </span><span class="p">(</span><span class="nf">exp2</span> <span class="nv">degree</span><span class="p">)))</span>

<span class="c1">; Available grid heights/widths are as follows:</span>
<span class="c1">; [3 5 9 17 33 65 129 257 513 1025 2049 4097 8193 16385 32769 65537</span>
<span class="c1">; 131073 262145 524289 1048577 2097153 4194305 8388609 16777217</span>
<span class="c1">; 33554433 67108865 134217729 268435457 536870913 1073741825])</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">blank-grid</span>
  <span class="s">&quot;Generates a grid of the given degree, filled in with zeros&quot;</span>
  <span class="p">[</span><span class="nv">degree</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">gsize</span> <span class="p">(</span><span class="nf">grid-size</span> <span class="nv">degree</span><span class="p">)]</span>
    <span class="p">(</span><span class="nf">vec</span> <span class="p">(</span><span class="nb">repeat </span><span class="nv">gsize</span>
      <span class="p">(</span><span class="nf">vec</span> <span class="p">(</span><span class="nb">repeat </span><span class="nv">gsize</span> <span class="mi">0</span><span class="p">))))))</span>

<span class="p">(</span><span class="nf">comment</span>
  <span class="p">(</span><span class="nf">print-m</span> <span class="p">(</span><span class="nf">blank-grid</span> <span class="mi">3</span><span class="p">))</span>
<span class="p">)</span>

<span class="c1">; = Coordinate Pattern (The Tricky Part) =</span>
<span class="c1">; We now have to figure out which coordinates need to be filled in</span>
<span class="c1">; on each pass.  A pass is defined as a square step followed by a</span>
<span class="c1">; diamond step. The next pass will be the square/dimaond steps on</span>
<span class="c1">; all the smaller squares generated in the pass. It works out that</span>
<span class="c1">; the number of passes required to fill in the grid is the same as</span>
<span class="c1">; the degree of the grid, where the first pass is 1.</span>
<span class="c1">;</span>
<span class="c1">; So we can easily find patterns in the coordinates for a given</span>
<span class="c1">; degree/pass, I&#39;ve laid out below all the coordinates for each pass</span>
<span class="c1">; for a 3rd degree grid (which is 9x9).</span>

<span class="c1">; Degree 3 Pass 1 Square</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [. . . . 1 . . . .] (4,4)</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [. . . . . . . . .]</span>

<span class="c1">; Degree 3 Pass 1 Diamond</span>
<span class="c1">; [. . . . 2 . . . .] (4,0)</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [2 . . . . . . . 2] (0,4) (8,4)</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [. . . . 2 . . . .] (4,8)</span>

<span class="c1">; Degree 3 Pass 2 Square</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [. . 3 . . . 3 . .] (2,2) (6,2)</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [. . 3 . . . 3 . .] (2,6) (6,6)</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [. . . . . . . . .]</span>

<span class="c1">; Degree 3 Pass 2 Diamond</span>
<span class="c1">; [. . 4 . . . 4 . .] (2,0) (6,0)</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [4 . . . 4 . . . 4] (0,2) (4,2) (8,2)</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [. . 4 . . . 4 . .] (2,4) (6,4)</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [4 . . . 4 . . . 4] (0,6) (4,6) (8,6)</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [. . 4 . . . 4 . .] (2,8) (6,8)</span>

<span class="c1">; Degree 3 Pass 3 Square</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [. 5 . 5 . 5 . 5 .] (1,1) (3,1) (5,1) (7,1)</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [. 5 . 5 . 5 . 5 .] (1,3) (3,3) (5,3) (7,3)</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [. 5 . 5 . 5 . 5 .] (1,5) (3,5) (5,5) (7,5)</span>
<span class="c1">; [. . . . . . . . .]</span>
<span class="c1">; [. 5 . 5 . 5 . 5 .] (1,7) (3,7) (5,7) (7,7)</span>
<span class="c1">; [. . . . . . . . .]</span>

<span class="c1">; Degree 3 Pass 3 Square</span>
<span class="c1">; [. 6 . 6 . 6 . 6 .] (1,0) (3,0) (5,0) (7,0)</span>
<span class="c1">; [6 . 6 . 6 . 6 . 6] (0,1) (2,1) (4,1) (6,1) (8,1)</span>
<span class="c1">; [. 6 . 6 . 6 . 6 .] (1,2) (3,2) (5,2) (7,2)</span>
<span class="c1">; [6 . 6 . 6 . 6 . 6] (0,3) (2,3) (4,3) (6,3) (8,3)</span>
<span class="c1">; [. 6 . 6 . 6 . 6 .] (1,4) (3,4) (5,4) (7,4)</span>
<span class="c1">; [6 . 6 . 6 . 6 . 6] (0,5) (2,5) (4,5) (6,5) (8,5)</span>
<span class="c1">; [. 6 . 6 . 6 . 6 .] (1,6) (3,6) (5,6) (7,6)</span>
<span class="c1">; [6 . 6 . 6 . 6 . 6] (0,7) (2,7) (4,7) (6,7) (8,7)</span>
<span class="c1">; [. 6 . 6 . 6 . 6 .] (1,8) (3,8) (5,8) (7,8)</span>
<span class="c1">;</span>
<span class="c1">; I make two different functions, one to give the coordinates for</span>
<span class="c1">; the square portion of each pass and one for the diamond portion of</span>
<span class="c1">; each pass. To find the actual patterns it was useful to first look</span>
<span class="c1">; only at the pattern in the y-coordinates, and figure out how that</span>
<span class="c1">; translated into the pattern for the x-coordinates.</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">grid-square-coords</span>
  <span class="s">&quot;Given a grid degree and pass number, returns all the coordinates</span>
<span class="s">  which need to be computed for the square step of that pass&quot;</span>
  <span class="p">[</span><span class="nv">degree</span> <span class="nv">pass</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">gsize</span> <span class="p">(</span><span class="nf">grid-size</span> <span class="nv">degree</span><span class="p">)</span>
        <span class="nv">start</span> <span class="p">(</span><span class="nf">exp2</span> <span class="p">(</span><span class="nb">- </span><span class="nv">degree</span> <span class="nv">pass</span><span class="p">))</span>
        <span class="nv">interval</span> <span class="p">(</span><span class="nb">* </span><span class="mi">2</span> <span class="nv">start</span><span class="p">)</span>
        <span class="nv">coords</span> <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nb">+ </span><span class="nv">start</span> <span class="p">(</span><span class="nb">* </span><span class="nv">interval</span> <span class="nv">%</span><span class="p">))</span>
                <span class="p">(</span><span class="nb">range </span><span class="p">(</span><span class="nf">exp2</span> <span class="p">(</span><span class="nb">dec </span><span class="nv">pass</span><span class="p">))))]</span>
    <span class="p">(</span><span class="nb">mapcat </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">y</span><span class="p">]</span>
      <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nb">vector </span><span class="nv">%</span> <span class="nv">y</span><span class="p">)</span> <span class="nv">coords</span><span class="p">))</span>
      <span class="nv">coords</span><span class="p">)))</span>
<span class="c1">;</span>
<span class="c1">; (grid-square-coords 3 2)</span>
<span class="c1">; =&gt; ([2 2] [6 2] [2 6] [6 6])</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">grid-diamond-coords</span>
  <span class="s">&quot;Given a grid degree and a pass number, returns all the</span>
<span class="s">  coordinates which need to be computed for the diamond step of that</span>
<span class="s">  pass&quot;</span>
  <span class="p">[</span><span class="nv">degree</span> <span class="nv">pass</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">gsize</span> <span class="p">(</span><span class="nf">grid-size</span> <span class="nv">degree</span><span class="p">)</span>
        <span class="nv">interval</span> <span class="p">(</span><span class="nf">exp2</span> <span class="p">(</span><span class="nb">- </span><span class="nv">degree</span> <span class="nv">pass</span><span class="p">))</span>
        <span class="nv">num-coords</span> <span class="p">(</span><span class="nf">grid-size</span> <span class="nv">pass</span><span class="p">)</span>
        <span class="nv">coords</span> <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nb">* </span><span class="nv">interval</span> <span class="nv">%</span><span class="p">)</span> <span class="p">(</span><span class="nb">range </span><span class="mi">0</span> <span class="nv">num-coords</span><span class="p">))]</span>
    <span class="p">(</span><span class="nb">mapcat </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">y</span><span class="p">]</span>
      <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">even?</span> <span class="p">(</span><span class="nb">/ </span><span class="nv">y</span> <span class="nv">interval</span><span class="p">))</span>
        <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nb">vector </span><span class="nv">%</span> <span class="nv">y</span><span class="p">)</span> <span class="p">(</span><span class="nb">take-nth </span><span class="mi">2</span> <span class="p">(</span><span class="nb">drop </span><span class="mi">1</span> <span class="nv">coords</span><span class="p">)))</span>
        <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nb">vector </span><span class="nv">%</span> <span class="nv">y</span><span class="p">)</span> <span class="p">(</span><span class="nb">take-nth </span><span class="mi">2</span> <span class="nv">coords</span><span class="p">))))</span>
      <span class="nv">coords</span><span class="p">)))</span>

<span class="c1">; (grid-diamond-coords 3 2)</span>
<span class="c1">; =&gt; ([2 0] [6 0] [0 2] [4 2] [8 2] [2 4] [6 4] [0 6] [4 6] [8 6] [2 8] [6 8])</span>

<span class="c1">; = Height Generation =</span>
<span class="c1">; We now work on functions which, given a coordinate, will return</span>
<span class="c1">; what value coordinate will have.</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">avg-points</span>
  <span class="s">&quot;Given a grid and an arbitrary number of points (of the form [x y])</span>
<span class="s">  returns the average of all the given points that are on the map.</span>
<span class="s">  Any points which are off the map are ignored&quot;</span>
  <span class="p">[</span><span class="nv">m</span> <span class="o">&amp;</span> <span class="nv">coords</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">grid-size</span> <span class="p">(</span><span class="nb">count </span><span class="nv">m</span><span class="p">)]</span>
    <span class="p">(</span><span class="nb">apply </span><span class="nv">avg</span>
      <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nb">apply </span><span class="nv">get-m</span> <span class="nv">m</span> <span class="nv">%</span><span class="p">)</span>
        <span class="p">(</span><span class="nf">filter</span>
          <span class="p">(</span><span class="k">fn </span><span class="p">[[</span><span class="nv">x</span> <span class="nv">y</span><span class="p">]]</span>
            <span class="p">(</span><span class="nb">and </span><span class="p">(</span><span class="nb">&lt; </span><span class="mi">-1</span> <span class="nv">x</span><span class="p">)</span> <span class="p">(</span><span class="nb">&gt; </span><span class="nv">grid-size</span> <span class="nv">x</span><span class="p">)</span>
                 <span class="p">(</span><span class="nb">&lt; </span><span class="mi">-1</span> <span class="nv">y</span><span class="p">)</span> <span class="p">(</span><span class="nb">&gt; </span><span class="nv">grid-size</span> <span class="nv">y</span><span class="p">)))</span>
          <span class="nv">coords</span><span class="p">)))))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">error</span>
  <span class="s">&quot;Returns a number between -e and e, inclusive&quot;</span>
  <span class="p">[</span><span class="nv">e</span><span class="p">]</span>
  <span class="p">(</span><span class="nb">- </span><span class="p">(</span><span class="nb">rand-int </span><span class="p">(</span><span class="nb">inc </span><span class="p">(</span><span class="nb">* </span><span class="mi">2</span> <span class="nv">e</span><span class="p">)))</span> <span class="nv">e</span><span class="p">))</span>

<span class="c1">; The next function is a little weird. It primarily takes in a</span>
<span class="c1">; point, then figures out the distance from that point to the points</span>
<span class="c1">; we&#39;ll take the average of. The locf (locator function) is used to</span>
<span class="c1">; return back the actual points to use. For the square portion it&#39;ll</span>
<span class="c1">; be the points diagonal from the given one, for the diamond portion</span>
<span class="c1">; it&#39;ll be the points to the top/bottom/left/right from the given</span>
<span class="c1">; one.</span>
<span class="c1">;</span>
<span class="c1">; Once it has those points, it finds the average and applies the</span>
<span class="c1">; error. The error function is nothing more than a number between</span>
<span class="c1">; -interval and +interval, where interval is the distance between</span>
<span class="c1">; the given point and one of the averaged points. It is important</span>
<span class="c1">; that the error decreases the more passes you do, which is why the</span>
<span class="c1">; interval is used.</span>
<span class="c1">;</span>
<span class="c1">; The error function is what should be messed with primarily if you</span>
<span class="c1">; want to change what kind of terrain you generate (a giant mountain</span>
<span class="c1">; instead of hills/valleys, for example). The one we use is uniform</span>
<span class="c1">; for all intervals, so it generates a uniform terrain.</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">grid-fill-point</span>
  <span class="p">[</span><span class="nv">locf</span> <span class="nv">m</span> <span class="nv">degree</span> <span class="nv">pass</span> <span class="nv">x</span> <span class="nv">y</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">interval</span> <span class="p">(</span><span class="nf">exp2</span> <span class="p">(</span><span class="nb">- </span><span class="nv">degree</span> <span class="nv">pass</span><span class="p">))</span>
        <span class="nv">leftx</span>  <span class="p">(</span><span class="nb">- </span><span class="nv">x</span> <span class="nv">interval</span><span class="p">)</span>
        <span class="nv">rightx</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">x</span> <span class="nv">interval</span><span class="p">)</span>
        <span class="nv">upy</span>    <span class="p">(</span><span class="nb">- </span><span class="nv">y</span> <span class="nv">interval</span><span class="p">)</span>
        <span class="nv">downy</span>  <span class="p">(</span><span class="nb">+ </span><span class="nv">y</span> <span class="nv">interval</span><span class="p">)</span>
        <span class="nv">v</span>      <span class="p">(</span><span class="nb">apply </span><span class="nv">avg-points</span> <span class="nv">m</span>
                <span class="p">(</span><span class="nf">locf</span> <span class="nv">x</span> <span class="nv">y</span> <span class="nv">leftx</span> <span class="nv">rightx</span> <span class="nv">upy</span> <span class="nv">downy</span><span class="p">))]</span>
    <span class="p">(</span><span class="nf">add-m</span> <span class="nv">m</span> <span class="nv">x</span> <span class="nv">y</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">v</span> <span class="p">(</span><span class="nf">error</span> <span class="nv">interval</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">grid-fill-point-square</span>
  <span class="s">&quot;Given a grid, the grid&#39;s degree, the current pass number, and a</span>
<span class="s">  point on the grid, fills in that point with the average (plus some</span>
<span class="s">  error) of the appropriate corner points, and returns the resultant</span>
<span class="s">  grid&quot;</span>
  <span class="p">(</span><span class="nb">partial </span><span class="nv">grid-fill-point</span>
    <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">_</span> <span class="nv">_</span> <span class="nv">leftx</span> <span class="nv">rightx</span> <span class="nv">upy</span> <span class="nv">downy</span><span class="p">]</span>
      <span class="p">[[</span><span class="nv">leftx</span> <span class="nv">upy</span><span class="p">]</span>
       <span class="p">[</span><span class="nv">rightx</span> <span class="nv">upy</span><span class="p">]</span>
       <span class="p">[</span><span class="nv">leftx</span> <span class="nv">downy</span><span class="p">]</span>
       <span class="p">[</span><span class="nv">rightx</span> <span class="nv">downy</span><span class="p">]])))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">grid-fill-point-diamond</span>
  <span class="s">&quot;Given a grid, the grid&#39;s degree, the current pass number, and a</span>
<span class="s">  point on the grid, fills in that point with the average (plus some</span>
<span class="s">  error) of the appropriate edge points, and returns the resultant</span>
<span class="s">  grid&quot;</span>
  <span class="p">(</span><span class="nb">partial </span><span class="nv">grid-fill-point</span>
    <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">x</span> <span class="nv">y</span> <span class="nv">leftx</span> <span class="nv">rightx</span> <span class="nv">upy</span> <span class="nv">downy</span><span class="p">]</span>
      <span class="p">[[</span><span class="nv">leftx</span> <span class="nv">y</span><span class="p">]</span>
       <span class="p">[</span><span class="nv">rightx</span> <span class="nv">y</span><span class="p">]</span>
       <span class="p">[</span><span class="nv">x</span> <span class="nv">upy</span><span class="p">]</span>
       <span class="p">[</span><span class="nv">x</span> <span class="nv">downy</span><span class="p">]])))</span>

<span class="c1">; = Filling in the Grid =</span>
<span class="c1">; We finally compose the functions we&#39;ve been creating to fill in</span>
<span class="c1">; the entire grid</span>

<span class="p">(</span><span class="kd">defn- </span><span class="nv">grid-fill-point-passes</span>
  <span class="s">&quot;Given a grid, a function to fill in coordinates, and a function</span>
<span class="s">  to generate those coordinates, fills in all coordinates for a</span>
<span class="s">  given pass, returning the resultant grid&quot;</span>
  <span class="p">[</span><span class="nv">m</span> <span class="nv">fill-f</span> <span class="nv">coord-f</span> <span class="nv">degree</span> <span class="nv">pass</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">reduce</span>
    <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">macc</span> <span class="p">[</span><span class="nv">x</span> <span class="nv">y</span><span class="p">]]</span> <span class="p">(</span><span class="nf">fill-f</span> <span class="nv">macc</span> <span class="nv">degree</span> <span class="nv">pass</span> <span class="nv">x</span> <span class="nv">y</span><span class="p">))</span>
    <span class="nv">m</span>
    <span class="p">(</span><span class="nf">coord-f</span> <span class="nv">degree</span> <span class="nv">pass</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">grid-pass</span>
  <span class="s">&quot;Given a grid and a pass number, does the square then the diamond</span>
<span class="s">  portion of the pass&quot;</span>
  <span class="p">[</span><span class="nv">m</span> <span class="nv">degree</span> <span class="nv">pass</span><span class="p">]</span>
  <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">m</span>
    <span class="p">(</span><span class="nf">grid-fill-point-passes</span>
      <span class="nv">grid-fill-point-square</span> <span class="nv">grid-square-coords</span> <span class="nv">degree</span> <span class="nv">pass</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">grid-fill-point-passes</span>
      <span class="nv">grid-fill-point-diamond</span> <span class="nv">grid-diamond-coords</span> <span class="nv">degree</span> <span class="nv">pass</span><span class="p">)))</span>

<span class="c1">; The most important function in this guide, does all the work</span>
<span class="p">(</span><span class="kd">defn </span><span class="nv">terrain</span>
  <span class="s">&quot;Given a grid degree, generates a uniformly random terrain on a</span>
<span class="s">  grid of that degree&quot;</span>
  <span class="p">([</span><span class="nv">degree</span><span class="p">]</span>
    <span class="p">(</span><span class="nf">terrain</span> <span class="p">(</span><span class="nf">blank-grid</span> <span class="nv">degree</span><span class="p">)</span> <span class="nv">degree</span><span class="p">))</span>
  <span class="p">([</span><span class="nv">m</span> <span class="nv">degree</span><span class="p">]</span>
    <span class="p">(</span><span class="nf">reduce</span>
      <span class="o">#</span><span class="p">(</span><span class="nf">grid-pass</span> <span class="nv">%1</span> <span class="nv">degree</span> <span class="nv">%2</span><span class="p">)</span>
      <span class="nv">m</span>
      <span class="p">(</span><span class="nb">range </span><span class="mi">1</span> <span class="p">(</span><span class="nb">inc </span><span class="nv">degree</span><span class="p">)))))</span>

<span class="p">(</span><span class="nf">comment</span>
  <span class="p">(</span><span class="nf">print-m</span>
    <span class="p">(</span><span class="nf">terrain</span> <span class="mi">5</span><span class="p">))</span>
<span class="p">)</span>

<span class="c1">; == The Results ==</span>
<span class="c1">; We now have a generated terrain, probably. We should check it.</span>
<span class="c1">; First we&#39;ll create an ASCII representation. But to do that we&#39;ll</span>
<span class="c1">; need some utility functions.</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">max-terrain-height</span>
  <span class="s">&quot;Returns the maximum height found in the given terrain grid&quot;</span>
  <span class="p">[</span><span class="nv">m</span><span class="p">]</span>
  <span class="p">(</span><span class="nb">reduce </span><span class="nv">max</span>
    <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nb">reduce max </span><span class="nv">%</span><span class="p">)</span> <span class="nv">m</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">min-terrain-height</span>
  <span class="s">&quot;Returns the minimum height found in the given terrain grid&quot;</span>
  <span class="p">[</span><span class="nv">m</span><span class="p">]</span>
  <span class="p">(</span><span class="nb">reduce </span><span class="nv">min</span>
    <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nb">reduce min </span><span class="nv">%</span><span class="p">)</span> <span class="nv">m</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">norm</span>
  <span class="s">&quot;Given x in the range (A,B), normalizes it into the range</span>
<span class="s">  (0,new-height)&quot;</span>
  <span class="p">[</span><span class="nv">A</span> <span class="nv">B</span> <span class="nv">new-height</span> <span class="nv">x</span><span class="p">]</span>
  <span class="p">(</span><span class="nb">int </span><span class="p">(</span><span class="nb">/ </span><span class="p">(</span><span class="nb">* </span><span class="p">(</span><span class="nb">- </span><span class="nv">x</span> <span class="nv">A</span><span class="p">)</span> <span class="nv">new-height</span><span class="p">)</span> <span class="p">(</span><span class="nb">- </span><span class="nv">B</span> <span class="nv">A</span><span class="p">))))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">normalize-terrain</span>
  <span class="s">&quot;Given a terrain map and a number of \&quot;steps\&quot;, normalizes the</span>
<span class="s">  terrain so all heights in it are in the range (0,steps)&quot;</span>
  <span class="p">[</span><span class="nv">m</span> <span class="nv">steps</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">max-height</span> <span class="p">(</span><span class="nf">max-terrain-height</span> <span class="nv">m</span><span class="p">)</span>
        <span class="nv">min-height</span> <span class="p">(</span><span class="nf">min-terrain-height</span> <span class="nv">m</span><span class="p">)</span>
        <span class="nv">norm-f</span> <span class="p">(</span><span class="nb">partial </span><span class="nv">norm</span> <span class="nv">min-height</span> <span class="nv">max-height</span> <span class="nv">steps</span><span class="p">)]</span>
    <span class="p">(</span><span class="nf">vec</span> <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nf">vec</span> <span class="p">(</span><span class="nb">map </span><span class="nv">norm-f</span> <span class="nv">%</span><span class="p">))</span> <span class="nv">m</span><span class="p">))))</span>

<span class="c1">; We now define which ASCII characters we want to use for which</span>
<span class="c1">; heights. The vector starts with the character for the lowest</span>
<span class="c1">; height and ends with the character for the heighest height.</span>

<span class="p">(</span><span class="k">def </span><span class="nv">tiles</span>
  <span class="p">[</span><span class="sc">\~</span> <span class="sc">\~</span> <span class="sc">\&quot;</span> <span class="sc">\&quot;</span> <span class="sc">\x</span> <span class="sc">\x</span> <span class="sc">\X</span> <span class="sc">\$</span> <span class="sc">\%</span> <span class="sc">\#</span> <span class="sc">\@</span><span class="p">])</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">tile-terrain</span>
  <span class="s">&quot;Given a terrain map, converts it into an ASCII tile map&quot;</span>
  <span class="p">[</span><span class="nv">m</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">vec</span> <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nf">vec</span> <span class="p">(</span><span class="nb">map </span><span class="nv">tiles</span> <span class="nv">%</span><span class="p">))</span>
    <span class="p">(</span><span class="nf">normalize-terrain</span> <span class="nv">m</span> <span class="p">(</span><span class="nb">dec </span><span class="p">(</span><span class="nb">count </span><span class="nv">tiles</span><span class="p">))))))</span>

<span class="p">(</span><span class="nf">comment</span>
  <span class="p">(</span><span class="nf">print-m</span>
    <span class="p">(</span><span class="nf">tile-terrain</span>
      <span class="p">(</span><span class="nf">terrain</span> <span class="mi">5</span><span class="p">)))</span>

<span class="c1">; [~ ~ &quot; &quot; x x x X % $ $ $ X X X X X X $ x x x X X X x x x x &quot; &quot; &quot; ~]</span>
<span class="c1">; [&quot; ~ &quot; &quot; x x X X $ $ $ X X X X X X X X X X X X X X x x x x &quot; &quot; &quot; &quot;]</span>
<span class="c1">; [&quot; &quot; &quot; x x x X X % $ % $ % $ $ X X X X $ $ $ X X X X x x x x &quot; &quot; &quot;]</span>
<span class="c1">; [&quot; &quot; &quot; x x X $ % % % % % $ % $ $ X X $ $ $ $ X X x x x x x x &quot; &quot; x]</span>
<span class="c1">; [&quot; x x x x X $ $ # % % % % % % $ X $ X X % $ % X X x x x x x x x x]</span>
<span class="c1">; [x x x X $ $ $ % % % % % $ % $ $ $ % % $ $ $ $ X X x x x x x x x x]</span>
<span class="c1">; [X X X $ % $ % % # % % $ $ % % % % $ % $ $ X $ X $ X X x x x X x x]</span>
<span class="c1">; [$ $ X $ $ % $ % % % % $ $ $ % # % % % X X X $ $ $ X X X x x x x x]</span>
<span class="c1">; [% X X % % $ % % % $ % $ % % % # @ % $ $ X $ X X $ X x X X x x x x]</span>
<span class="c1">; [$ $ % % $ $ % % $ $ X $ $ % % % % $ $ X $ $ X X X X X X x x x x x]</span>
<span class="c1">; [% % % X $ $ % $ $ X X $ $ $ $ % % $ $ X X X $ X X X x x X x x X X]</span>
<span class="c1">; [$ $ $ X $ $ X $ X X X $ $ $ $ % $ $ $ $ $ X $ X x X X X X X x X X]</span>
<span class="c1">; [$ $ $ $ X X $ X X X X X $ % % % % % $ X $ $ $ X x X X X $ X X $ $]</span>
<span class="c1">; [X $ $ $ $ $ X X X X X X X % $ % $ $ $ X X X X X x x X X x X X $ $]</span>
<span class="c1">; [$ $ X X $ X X x X $ $ X X $ % X X X X X X X X X x X X x x X X X X]</span>
<span class="c1">; [$ $ X X X X X X X $ $ $ $ $ X $ X X X X X X X x x x x x x x X X X]</span>
<span class="c1">; [% % % $ $ X $ X % X X X % $ $ X X X X X X x x x x x x x x x X X $]</span>
<span class="c1">; [$ % % $ $ $ X X $ $ $ $ $ $ X X X X x X x x x x &quot; x x x &quot; x x x x]</span>
<span class="c1">; [$ X % $ $ $ $ $ X X X X X $ $ X X X X X X x x &quot; &quot; &quot; &quot; &quot; &quot; &quot; &quot; x x]</span>
<span class="c1">; [$ X $ $ % % $ X X X $ X X X x x X X x x x x x &quot; &quot; &quot; &quot; &quot; ~ &quot; &quot; &quot; &quot;]</span>
<span class="c1">; [$ $ X X % $ % X X X X X X X X x x X X X x x x &quot; &quot; &quot; &quot; &quot; &quot; ~ &quot; &quot; &quot;]</span>
<span class="c1">; [$ $ X $ % $ $ X X X X X X x x x x x x x x x &quot; &quot; &quot; &quot; &quot; &quot; &quot; &quot; &quot; ~ ~]</span>
<span class="c1">; [$ $ $ $ $ X X $ X X X X X x x x x x x x x &quot; &quot; &quot; &quot; &quot; &quot; &quot; ~ &quot; &quot; &quot; ~]</span>
<span class="c1">; [$ % X X $ $ $ $ X X X X x x x x x x x x x x &quot; &quot; &quot; &quot; ~ &quot; &quot; ~ &quot; &quot; ~]</span>
<span class="c1">; [% $ $ X $ X $ X $ X $ X x x x x x x x x x x &quot; &quot; &quot; &quot; ~ ~ ~ &quot; ~ &quot; ~]</span>
<span class="c1">; [$ X X X X $ $ $ $ $ X x x x x x x x x x x &quot; &quot; &quot; &quot; ~ ~ ~ ~ ~ ~ ~ ~]</span>
<span class="c1">; [X x X X x X X X X X X X X x x x x x x x x x &quot; &quot; &quot; ~ ~ &quot; &quot; ~ ~ ~ ~]</span>
<span class="c1">; [x x x x x x X x X X x X X X x x x x x x x &quot; x &quot; &quot; &quot; &quot; &quot; ~ ~ ~ ~ ~]</span>
<span class="c1">; [x x x x x x x x X X X X $ X X x X x x x x x x x x &quot; ~ ~ ~ ~ ~ ~ ~]</span>
<span class="c1">; [&quot; x x x x x X x X X X X X X X X X x x x x x x &quot; &quot; &quot; &quot; ~ ~ ~ ~ ~ ~]</span>
<span class="c1">; [&quot; &quot; &quot; x x x X X X X $ $ $ X X X X X X x x x x x x x x &quot; &quot; ~ ~ ~ ~]</span>
<span class="c1">; [&quot; &quot; &quot; &quot; x x x X X X X X $ $ X X x X X x x x x x x x &quot; &quot; &quot; &quot; &quot; ~ ~]</span>
<span class="c1">; [~ &quot; &quot; x x x x X $ X $ X $ $ X x X x x x x x x x x x x x x &quot; &quot; &quot; ~]</span>
<span class="p">)</span>

<span class="c1">; = Pictures! =</span>
<span class="c1">; ASCII is cool, but pictures are better. First we import some java</span>
<span class="c1">; libraries that we&#39;ll need, then define the colors for each level</span>
<span class="c1">; just like we did tiles for the ascii representation.</span>

<span class="p">(</span><span class="nf">import</span>
  <span class="ss">&#39;java.awt.image.BufferedImage</span>
  <span class="ss">&#39;javax.imageio.ImageIO</span>
  <span class="ss">&#39;java.io.File</span><span class="p">)</span>

<span class="p">(</span><span class="k">def </span><span class="nv">colors</span>
  <span class="p">[</span><span class="mi">0</span><span class="nv">x1437AD</span> <span class="mi">0</span><span class="nv">x04859D</span> <span class="mi">0</span><span class="nv">x007D1C</span> <span class="mi">0</span><span class="nv">x007D1C</span> <span class="mi">0</span><span class="nv">x24913C</span>
   <span class="mi">0</span><span class="nv">x00C12B</span> <span class="mi">0</span><span class="nv">x38E05D</span> <span class="mi">0</span><span class="nv">xA3A3A4</span> <span class="mi">0</span><span class="nv">x757575</span> <span class="mi">0</span><span class="nv">xFFFFFF</span><span class="p">])</span>

<span class="c1">; Finally we reduce over a BufferedImage instance to output every</span>
<span class="c1">; tile as a single pixel on it.</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">img-terrain</span>
  <span class="s">&quot;Given a terrain map and a file name, outputs a png representation</span>
<span class="s">  of the terrain map to that file&quot;</span>
  <span class="p">[</span><span class="nv">m</span> <span class="nv">file</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">img</span> <span class="p">(</span><span class="nf">BufferedImage.</span> <span class="p">(</span><span class="nb">count </span><span class="nv">m</span><span class="p">)</span> <span class="p">(</span><span class="nb">count </span><span class="nv">m</span><span class="p">)</span> <span class="nv">BufferedImage/TYPE_INT_RGB</span><span class="p">)]</span>
    <span class="p">(</span><span class="nf">reduce</span>
      <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">rown</span> <span class="nv">row</span><span class="p">]</span>
        <span class="p">(</span><span class="nf">reduce</span>
          <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">coln</span> <span class="nv">tile</span><span class="p">]</span>
            <span class="p">(</span><span class="nf">.setRGB</span> <span class="nv">img</span> <span class="nv">coln</span> <span class="nv">rown</span> <span class="p">(</span><span class="nf">colors</span> <span class="nv">tile</span><span class="p">))</span>
            <span class="p">(</span><span class="nb">inc </span><span class="nv">coln</span><span class="p">))</span>
          <span class="mi">0</span> <span class="nv">row</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">inc </span><span class="nv">rown</span><span class="p">))</span>
      <span class="mi">0</span> <span class="p">(</span><span class="nf">normalize-terrain</span> <span class="nv">m</span> <span class="p">(</span><span class="nb">dec </span><span class="p">(</span><span class="nb">count </span><span class="nv">colors</span><span class="p">))))</span>
    <span class="p">(</span><span class="nf">ImageIO/write</span> <span class="nv">img</span> <span class="s">&quot;png&quot;</span> <span class="p">(</span><span class="nf">File.</span> <span class="nv">file</span><span class="p">))))</span>

<span class="p">(</span><span class="nf">comment</span>
  <span class="p">(</span><span class="nf">img-terrain</span>
    <span class="p">(</span><span class="nf">terrain</span> <span class="mi">10</span><span class="p">)</span>
    <span class="s">&quot;resources/terrain.png&quot;</span><span class="p">)</span>

  <span class="c1">; https://raw2.github.com/mediocregopher/diamond-square/master/resources/terrain.png</span>
<span class="p">)</span>

<span class="c1">; == Conclusion ==</span>
<span class="c1">; There&#39;s still a lot of work to be done. The algorithm starts</span>
<span class="c1">; taking a non-trivial amount of time around the 10th degree, which</span>
<span class="c1">; is only a 1025x1025px image. I need to profile the code and find</span>
<span class="c1">; out where the bottlenecks are. It&#39;s possible re-organizing the</span>
<span class="c1">; code to use pmaps instead of reduces in some places could help.</span>
</code></pre></div>

        </article>

        <div id="post-share">
            <p id="post-share-cta">Did you like this article? Share it!</p>
            <div id="post-share-buttons">
                <a target="_blank" href="https://twitter.com/home?status=Random Terrain Generation, A Clojure Walkthrough https://cryptic.io/clojure-diamond-square/" title="Share on Twitter">
                    <svg id="post-share-twitter" class="post-share-button">
                        <use xlink:href="/imgs/svg.svg#svg-twitter" x="0" y="0" width="100%" height="100%"></use>
                    </svg>
                </a>
                <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://cryptic.io/clojure-diamond-square/" title="Share on Facebook">
                    <svg id="post-share-facebook" class="post-share-button">
                        <use xlink:href="/imgs/svg.svg#svg-facebook" x="0" y="0" width="100%" height="100%"></use>
                    </svg>
                </a>
                <a target="_blank" href="https://plus.google.com/share?url=https://cryptic.io/clojure-diamond-square/" title="Share on Google">
                    <svg id="post-share-google" class="post-share-button">
                        <use xlink:href="/imgs/svg.svg#svg-google" x="0" y="0" width="100%" height="100%"></use>
                    </svg>
                </a>
            </div>
        </div>

    </div>

    <footer id="footer">

        <h2 class="page-sub-header">Author</h2>

        <div id="author">

            <div class="member">

    <div class="member-header">

        <div class="member-author-avatar">
            <img class="member-author-img" src="https://avatars.githubusercontent.com/u/933154"/>
        </div>

        <div class="member-author-words">
            <div class="member-author-name">
                <span>Brian Picciano</span>
                <span class="member-author-username">mediocregopher</span>
            </div>
            <p class="member-author-bio">Coding, climbing, longboarding, movie watcher, ginger. I love go, clojure, redis, and sometimes erlang.</p>

            <div class="member-author-companies">

                <i class="fa fa-building-o"></i>

                

                

                

                    <a href="http://grooveshark.com/" class="company-link">Grooveshark</a>

                

                

                

                

                

                

                

                

                

            </div>
        </div>

        <div class="member-author-socials">

            
            <a href="http://mediocregopher.com" class="member-author-social" title="Website of Brian Picciano">
                Website
            </a>
            

            
            <a href="mailto:mediocregopher@gmail.com" class="member-author-social" title="Email of Brian Picciano">
                Email
            </a>
            

            
            <a href="http://github.com/mediocregopher" class="member-author-social" title="Github of Brian Picciano">
                Github
            </a>
            

            
            <a href="https://twitter.com/mediocre_gopher" class="member-author-social" title="Twitter of Brian Picciano">
                Twitter
            </a>
            

            

        </div>

    </div>

    <div class="member-related-posts">

        <div class="member-related-posts-title">
            <h2 class="member-related-posts-title-text">Posts by mediocregopher</h2>
        </div>

        <ul class="member-related-posts-list">

            

            

            <li class="member-related-post cf">
                <i class="fa fa-angle-right"></i>
                <a href="/go-http/" title="Go's http package by example">
                    <span>Go's http package by example</span>
                </a>
            </li>

            

            <li class="member-related-post cf">
                <i class="fa fa-angle-right"></i>
                <a href="/rabbit-hole/" title="Rabbit Hole">
                    <span>Rabbit Hole</span>
                </a>
            </li>

            

            <li class="member-related-post cf">
                <i class="fa fa-angle-right"></i>
                <a href="/protip-sleep/" title="Protip - Bash Sleep">
                    <span>Protip - Bash Sleep</span>
                </a>
            </li>

            

            <li class="member-related-post cf">
                <i class="fa fa-angle-right"></i>
                <a href="/erlang-pitfalls/" title="Erlang Pitfalls">
                    <span>Erlang Pitfalls</span>
                </a>
            </li>

            

            <li class="member-related-post cf">
                <i class="fa fa-angle-right"></i>
                <a href="/clojure-diamond-square/" title="Random Terrain Generation, A Clojure Walkthrough">
                    <span>Random Terrain Generation, A Clojure Walkthrough</span>
                </a>
            </li>

            

        </ul>

        <a class="member-related-posts-all-link" href="/tags#mediocregopher" title="See all posts by mediocregopher">See all posts by mediocregopher</a>

    </div>

</div>


        </div>

        <h2 class="page-sub-header">Comments</h2>

        <div id="disqus_thread"></div>

    </footer>














    </div>

    <footer id="bottom-band" class="cf">

    

    <div id="bottom-recent" class="bottom-section">

        <h2 class="recent-posts-title page-sub-header">Recent Posts</h2>

        <ul class="recent-posts-list">

            

            

            

            <li class="recent-post cf">

                <div class="recent-post-words">

                    <div class="recent-post-title">

                        <h4 class="recent-post-title-text">
                            <a class="recent-post-title-text-link" href="/developing-gamepad-virtual-keyboard/" title="Considerations for developing a gamepad virtual keyboard, Part 1: The interface">
                                Considerations for developing a gamepad virtual keyboard, Part 1: The interface
                            </a>

                            
                            <a class="post-tag" href="/tags/" title="flux">#flux</a>
                            
                            <a class="post-tag" href="/tags/" title="daisywheeljs">#daisywheeljs</a>
                            
                            <a class="post-tag" href="/tags/" title="gamepad">#gamepad</a>
                            
                            <a class="post-tag" href="/tags/" title="html5">#html5</a>
                            

                        </h4>

                    </div>

                    <div class="recent-post-metadata">

                        <span class="recent-post-authoring-info">
                            <a href="/tags#likethemammal" class="recent-post-author-name" title="Chris Dolphin">Chris Dolphin</a>
                            •
                            <span class="recent-post-date">12 Sep 2015</span>
                        </span>

                    </div>

                    <a class="recent-post-link" href="/developing-gamepad-virtual-keyboard/" title="Considerations for developing a gamepad virtual keyboard, Part 1: The interface"></a>

                </div>

                <div class="recent-post-author-avatar">
                    <a href="/members#likethemammal" title="likethemammal">
                        <img class="recent-post-author-img" src="https://avatars1.githubusercontent.com/u/3430841" alt="likethemammal Avatar Image" title="likethemammal"/>
                    </a>
                </div>

            </li>

            

            

            

            

            

            

            

            

            

            

            

            <li class="recent-post cf">

                <div class="recent-post-words">

                    <div class="recent-post-title">

                        <h4 class="recent-post-title-text">
                            <a class="recent-post-title-text-link" href="/intro-to-daisywheeljs/" title="Adding the DaisywheelJS onscreen-keyboard to HTML5 Gamepad projects">
                                Adding the DaisywheelJS onscreen-keyboard to HTML5 Gamepad projects
                            </a>

                            
                            <a class="post-tag" href="/tags/" title="daisywheeljs">#daisywheeljs</a>
                            
                            <a class="post-tag" href="/tags/" title="daisywheel">#daisywheel</a>
                            
                            <a class="post-tag" href="/tags/" title="gamepad">#gamepad</a>
                            
                            <a class="post-tag" href="/tags/" title="html5">#html5</a>
                            

                        </h4>

                    </div>

                    <div class="recent-post-metadata">

                        <span class="recent-post-authoring-info">
                            <a href="/tags#likethemammal" class="recent-post-author-name" title="Chris Dolphin">Chris Dolphin</a>
                            •
                            <span class="recent-post-date">31 Aug 2015</span>
                        </span>

                    </div>

                    <a class="recent-post-link" href="/intro-to-daisywheeljs/" title="Adding the DaisywheelJS onscreen-keyboard to HTML5 Gamepad projects"></a>

                </div>

                <div class="recent-post-author-avatar">
                    <a href="/members#likethemammal" title="likethemammal">
                        <img class="recent-post-author-img" src="https://avatars1.githubusercontent.com/u/3430841" alt="likethemammal Avatar Image" title="likethemammal"/>
                    </a>
                </div>

            </li>

            

            

            

            

            

            

            

            

            

            

            

            

            

            <li class="recent-post cf">

                <div class="recent-post-words">

                    <div class="recent-post-title">

                        <h4 class="recent-post-title-text">
                            <a class="recent-post-title-text-link" href="/go-http/" title="Go's http package by example">
                                Go's http package by example
                            </a>

                            
                            <a class="post-tag" href="/tags/" title="golang">#golang</a>
                            
                            <a class="post-tag" href="/tags/" title="http">#http</a>
                            
                            <a class="post-tag" href="/tags/" title="middleware">#middleware</a>
                            

                        </h4>

                    </div>

                    <div class="recent-post-metadata">

                        <span class="recent-post-authoring-info">
                            <a href="/tags#mediocregopher" class="recent-post-author-name" title="Brian Picciano">Brian Picciano</a>
                            •
                            <span class="recent-post-date">15 Jul 2015</span>
                        </span>

                    </div>

                    <a class="recent-post-link" href="/go-http/" title="Go's http package by example"></a>

                </div>

                <div class="recent-post-author-avatar">
                    <a href="/members#mediocregopher" title="mediocregopher">
                        <img class="recent-post-author-img" src="https://avatars.githubusercontent.com/u/933154" alt="mediocregopher Avatar Image" title="mediocregopher"/>
                    </a>
                </div>

            </li>

            

            

            

            

            

            

            

            

            

            

            

            <li class="recent-post cf">

                <div class="recent-post-words">

                    <div class="recent-post-title">

                        <h4 class="recent-post-title-text">
                            <a class="recent-post-title-text-link" href="/rabbit-hole/" title="Rabbit Hole">
                                Rabbit Hole
                            </a>

                            
                            <a class="post-tag" href="/tags/" title="debug">#debug</a>
                            
                            <a class="post-tag" href="/tags/" title="php">#php</a>
                            
                            <a class="post-tag" href="/tags/" title="sysdig">#sysdig</a>
                            
                            <a class="post-tag" href="/tags/" title="dns">#dns</a>
                            

                        </h4>

                    </div>

                    <div class="recent-post-metadata">

                        <span class="recent-post-authoring-info">
                            <a href="/tags#mediocregopher" class="recent-post-author-name" title="Brian Picciano">Brian Picciano</a>
                            •
                            <span class="recent-post-date">11 Mar 2015</span>
                        </span>

                    </div>

                    <a class="recent-post-link" href="/rabbit-hole/" title="Rabbit Hole"></a>

                </div>

                <div class="recent-post-author-avatar">
                    <a href="/members#mediocregopher" title="mediocregopher">
                        <img class="recent-post-author-img" src="https://avatars.githubusercontent.com/u/933154" alt="mediocregopher Avatar Image" title="mediocregopher"/>
                    </a>
                </div>

            </li>

            

            

            

            

            

            

            

            

            

            

            

            <li class="recent-post cf">

                <div class="recent-post-words">

                    <div class="recent-post-title">

                        <h4 class="recent-post-title-text">
                            <a class="recent-post-title-text-link" href="/protip-sleep/" title="Protip - Bash Sleep">
                                Protip - Bash Sleep
                            </a>

                            
                            <a class="post-tag" href="/tags/" title="bash">#bash</a>
                            
                            <a class="post-tag" href="/tags/" title="protip">#protip</a>
                            

                        </h4>

                    </div>

                    <div class="recent-post-metadata">

                        <span class="recent-post-authoring-info">
                            <a href="/tags#mediocregopher" class="recent-post-author-name" title="Brian Picciano">Brian Picciano</a>
                            •
                            <span class="recent-post-date">01 Dec 2014</span>
                        </span>

                    </div>

                    <a class="recent-post-link" href="/protip-sleep/" title="Protip - Bash Sleep"></a>

                </div>

                <div class="recent-post-author-avatar">
                    <a href="/members#mediocregopher" title="mediocregopher">
                        <img class="recent-post-author-img" src="https://avatars.githubusercontent.com/u/933154" alt="mediocregopher Avatar Image" title="mediocregopher"/>
                    </a>
                </div>

            </li>

            

            

            

            

            

            

            

        </ul>

    </div>

    

    <div id="bottom-tags" class="bottom-section">

        <h2 class="page-sub-header">Tags</h2>

        <ul id="bottom-tags-list">
            
            <li class="post-tag"><a href="/tags#aws" title="aws">#aws<span>(1)</span></a></li>
            
            <li class="post-tag"><a href="/tags#apache" title="apache">#apache<span>(1)</span></a></li>
            
            <li class="post-tag"><a href="/tags#bash" title="bash">#bash<span>(2)</span></a></li>
            
            <li class="post-tag"><a href="/tags#clojurescript" title="clojurescript">#clojurescript<span>(1)</span></a></li>
            
            <li class="post-tag"><a href="/tags#javascript" title="javascript">#javascript<span>(2)</span></a></li>
            
            <li class="post-tag"><a href="/tags#react" title="react">#react<span>(2)</span></a></li>
            
            <li class="post-tag"><a href="/tags#firebase" title="firebase">#firebase<span>(1)</span></a></li>
            
            <li class="post-tag"><a href="/tags#clojure" title="clojure">#clojure<span>(1)</span></a></li>
            
            <li class="post-tag"><a href="/tags#terrain" title="terrain">#terrain<span>(1)</span></a></li>
            
            <li class="post-tag"><a href="/tags#erlang" title="erlang">#erlang<span>(1)</span></a></li>
            
            <li class="post-tag"><a href="/tags#jekyll" title="jekyll">#jekyll<span>(2)</span></a></li>
            
            <li class="post-tag"><a href="/tags#github-pages" title="github-pages">#github-pages<span>(2)</span></a></li>
            
            <li class="post-tag"><a href="/tags#dev-blog" title="dev-blog">#dev-blog<span>(1)</span></a></li>
            
            <li class="post-tag"><a href="/tags#liquid" title="liquid">#liquid<span>(1)</span></a></li>
            
            <li class="post-tag"><a href="/tags#frp" title="frp">#frp<span>(1)</span></a></li>
            
            <li class="post-tag"><a href="/tags#functional" title="functional">#functional<span>(1)</span></a></li>
            
            <li class="post-tag"><a href="/tags#reactive" title="reactive">#reactive<span>(1)</span></a></li>
            
            <li class="post-tag"><a href="/tags#elm" title="elm">#elm<span>(1)</span></a></li>
            
            <li class="post-tag"><a href="/tags#om" title="om">#om<span>(1)</span></a></li>
            
            <li class="post-tag"><a href="/tags#protip" title="protip">#protip<span>(1)</span></a></li>
            
            <li class="post-tag"><a href="/tags#debug" title="debug">#debug<span>(1)</span></a></li>
            
            <li class="post-tag"><a href="/tags#php" title="php">#php<span>(1)</span></a></li>
            
            <li class="post-tag"><a href="/tags#sysdig" title="sysdig">#sysdig<span>(1)</span></a></li>
            
            <li class="post-tag"><a href="/tags#dns" title="dns">#dns<span>(1)</span></a></li>
            
            <li class="post-tag"><a href="/tags#golang" title="golang">#golang<span>(1)</span></a></li>
            
            <li class="post-tag"><a href="/tags#http" title="http">#http<span>(1)</span></a></li>
            
            <li class="post-tag"><a href="/tags#middleware" title="middleware">#middleware<span>(1)</span></a></li>
            
            <li class="post-tag"><a href="/tags#daisywheeljs" title="daisywheeljs">#daisywheeljs<span>(2)</span></a></li>
            
            <li class="post-tag"><a href="/tags#daisywheel" title="daisywheel">#daisywheel<span>(1)</span></a></li>
            
            <li class="post-tag"><a href="/tags#gamepad" title="gamepad">#gamepad<span>(2)</span></a></li>
            
            <li class="post-tag"><a href="/tags#html5" title="html5">#html5<span>(2)</span></a></li>
            
            <li class="post-tag"><a href="/tags#flux" title="flux">#flux<span>(1)</span></a></li>
            
        </ul>

    </div>
</footer>

<div id="copyright-band">

    <small id="copyright">Designed by <a href="http://likethemammal.com" title="Chris Dolphin's Personal Site">Chris Dolphin</a> and hosted on <a href="http://github.com/cryptic-io/cryptic-chat/" title="Cryptic IO Github Repo">Github</a></small>

</div>


  </body>

  

    <script type="text/javascript">
    var parent = (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]);
    var disqus_shortname = 'crypticio'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        parent.appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        parent.appendChild(s);
    }());
</script>


  

  <script>
    console.log(' \
           ▄▄▀▀▀▀▀▀▀▀▀▄▄             \n \
████▄   ▄█▀             ▀▀▄   ▄▄███▀ \n \
   ▀████▌                  ████▀▀    \n \
      █▀███▄▄          ▄████▀▌       \n \
     █    ▀▀███▄▄▄▄▄████▀    █       \n \
     █        ▀██████▀       ▐▌      \n \
     █         ▀███▀         ▐       \n \
     ▐▌         ▐██          █       \n \
      ▐█        ▐██        ▄█        \n \
        ▀▄      ▐██       █▀         \n \
          ▀▀▄▄  ▐██   ▄▄▀            \n \
              ▀▀▐██▀▀                \n \
                ▐██                  \n \
                ▐██                  \n \
                ▐██                  \
');
  </script>
</html>
